
## API 接口说明

### 用户管理接口

#### 1. 用户注册

- **接口**: `POST /regist/users`
- **功能**: 注册新用户
- **请求格式**: JSON
- **请求参数**:
  ```json
  {
    "user_name": "string",        // 用户名，必填，4-20字符
    "pass_wd": "string",          // 密码，必填，最少8字符
    "user_id": int,               // 用户唯一标识，必填
    "user_type": int,             // 用户类型，必填
    "gateway_device_id": int      // 用户所属网关设备ID，必填，注意：用户注册之前需先进行设备注册，获取到真实设备id之后才可以进行用户注册
  }
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "用户注册成功",
    "data": {
      "ID": 1,
      "CreatedAt": "2025-03-22T23:26:54.346+08:00",
      "UpdatedAt": "2025-03-22T23:26:54.346+08:00",
      "DeletedAt": null,
      "username": "testuser01",
      "user_id": 10001,
      "user_type": 1,
      "gateway_device_id": 2001,
      "status": null,
      "online_duration": 0,
      "cert_id": "",
      "key_id": "",
      "email": ""
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "用户ID已存在"
  }
  ```

#### 2. 获取用户列表

- **接口**: `GET /search/users`
- **功能**: 获取所有用户信息
- **请求格式**: 无参数
- **响应格式**: JSON
- **响应示例**:
  ```json
  {
    "users": [
      {
        "ID": 1,
        "CreatedAt": "2025-03-22T23:26:54.346+08:00",
        "UpdatedAt": "2025-03-22T23:26:54.346+08:00",
        "DeletedAt": null,
        "username": "user_1001_1",
        "user_id": 10000,
        "user_type": 2,
        "gateway_device_id": 1001,
        "status": null,
        "online_duration": 768,
        "cert_id": "",
        "key_id": "",
        "email": "GjWRSP1R@example.com",
        "permission_mask": "11100010",
        "last_login_timestamp": null,
        "offline_timestamp": null,
        "login_ip": "212.193.3.138",
        "illegal_login_times": null
      }
    ]
  }
  ```
- **响应字段说明**:

| 字段名               | 类型     | 描述                                       |
| -------------------- | -------- | ------------------------------------------ |
| ID                   | INT      | 数据库自增主键                             |
| CreatedAt            | DATETIME | 记录创建时间                               |
| UpdatedAt            | DATETIME | 记录最后更新时间                           |
| DeletedAt            | DATETIME | 记录删除时间（null表示未删除）             |
| username             | STRING   | 用户名                                     |
| user_id              | INT      | 用户唯一标识                               |
| user_type            | INT      | 用户类型                                   |
| gateway_device_id    | INT      | 用户所属网关设备ID                         |
| status               | INT      | 用户状态（1:在线，2:离线，3:冻结，4:注销） |
| online_duration      | INT      | 用户在线时长（秒）                         |
| cert_id              | STRING   | 证书ID                                     |
| key_id               | STRING   | 密钥ID                                     |
| email                | STRING   | 邮箱地址                                   |
| permission_mask      | STRING   | 权限位掩码                                 |
| last_login_timestamp | DATETIME | 最后登录时间                               |
| offline_timestamp    | DATETIME | 最后离线时间                               |
| login_ip             | STRING   | 用户登录IP                                 |
| illegal_login_times  | INT      | 非法登录尝试次数                           |

#### 3. 指定用户查找

- **接口**: `GET /search/user`
- **功能**: 根据ID查询指定用户信息
- **请求格式**: URL查询参数
- **请求参数**:
  - id: 用户ID，必填，整数类型
- **请求示例**: `http://localhost:8080/search/user?id=10001`
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "用户查询成功",
    "data": {
      "ID": 1,
      "Username": "用户名1",
      "UserID": 10001,
      "UserType": 1,
      "GatewayDeviceID": 1001,
      "Status": 1,
      "OnlineDuration": 3600,
      "CertID": "cert_id_1",
      "KeyID": "key_id_1",
      "Email": "user1@example.com",
      "CreatedAt": "2024-03-05T15:00:00Z"
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "用户不存在"
  }
  ```

#### 4. 更新用户信息

- **接口**: `PUT /update/users/:id`
- **功能**: 更新指定用户的信息
- **路径参数**: id - 用户ID
- **请求格式**: JSON
- **请求参数**: 与注册接口相同，字段可选
- **请求示例**:
  ```json
  {
    "userName": "新用户名",
    "passWD": "新密码",
    "userType": 2,
    "email": "newemail@example.com"
  }
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "message": "用户信息更新成功"
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "用户不存在"
  }
  ```

### 设备管理接口

#### 1. 设备注册

- **接口**: `POST /regist/devices`
- **功能**: 注册新设备
- **请求格式**: JSON
- **请求参数**:
  ```json
  {
    "device_name": "string",          // 设备名称，必填，4-50字符
    "device_type": int,               // 设备类型，必填，1-4分别代表不同类型设备
    "pass_wd": "string",              // 设备登录口令，必填，最少8字符
    "device_id": int,                 // 设备唯一标识，必填
    "superior_device_id": int         // 上级设备ID，必填（安全接入管理设备为0）
  }
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "设备注册成功",
    "data": {
      "ID": 1,
      "CreatedAt": "2025-03-22T23:26:54.327+08:00",
      "UpdatedAt": "2025-03-22T23:26:54.327+08:00",
      "DeletedAt": null,
      "device_name": "TestDevice01",
      "device_type": 1,
      "password": "password123",
      "device_id": 2001,
      "superior_device_id": 0,
      "device_status": 2,
      "peak_cpu_usage": 0,
      "peak_memory_usage": 0,
      "online_duration": 0,
      "cert_id": "",
      "key_id": "",
      "register_ip": "127.0.0.1",
      "email": "",
      "hardware_fingerprint": "",
      "anonymous_user": ""
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "设备ID已存在"
  }
  ```

#### 2. 获取设备列表

- **接口**: `GET /search/devices`
- **功能**: 获取所有设备信息
- **请求格式**: 无参数
- **响应格式**: JSON
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "获取设备列表成功",
    "data": [
      {
        "ID": 1,
        "CreatedAt": "2025-03-22T23:26:54.327+08:00",
        "UpdatedAt": "2025-03-22T23:26:54.327+08:00",
        "DeletedAt": null,
        "device_name": "安全接入管理设备",
        "device_type": 4,
        "password": "admin123456",
        "device_id": 1000,
        "superior_device_id": 0,
        "device_status": 1,
        "peak_cpu_usage": 0,
        "peak_memory_usage": 0,
        "online_duration": 0,
        "cert_id": "",
        "key_id": "",
        "register_ip": "220.42.76.214",
        "email": "VCSNayol@company.net",
        "hardware_fingerprint": "",
        "anonymous_user": ""
      }
    ]
  }
  ```
- **响应字段说明**:

| 字段名               | 类型     | 描述                                                                        |
| -------------------- | -------- | --------------------------------------------------------------------------- |
| ID                   | INT      | 数据库自增主键                                                              |
| CreatedAt            | DATETIME | 记录创建时间                                                                |
| UpdatedAt            | DATETIME | 记录最后更新时间                                                            |
| DeletedAt            | DATETIME | 记录删除时间（null表示未删除）                                              |
| device_name          | STRING   | 设备名称                                                                    |
| device_type          | INT      | 设备类型（1:网关设备A型，2:网关设备B型，3:网关设备C型，4:安全接入管理设备） |
| password             | STRING   | 设备登录口令                                                                |
| device_id            | INT      | 设备唯一标识                                                                |
| superior_device_id   | INT      | 上级设备ID（安全接入管理设备为0）                                           |
| device_status        | INT      | 设备状态（1:在线，2:离线，3:冻结，4:注销）                                  |
| peak_cpu_usage       | INT      | 峰值CPU使用率（百分比）                                                     |
| peak_memory_usage    | INT      | 峰值内存使用率（百分比）                                                    |
| online_duration      | INT      | 设备在线时长（秒）                                                          |
| cert_id              | STRING   | 证书ID                                                                      |
| key_id               | STRING   | 密钥ID                                                                      |
| register_ip          | STRING   | 设备注册IP                                                                  |
| email                | STRING   | 联系邮箱                                                                    |
| hardware_fingerprint | STRING   | 设备硬件指纹                                                                |
| anonymous_user       | STRING   | 匿名用户                                                                    |

#### 3. 指定设备查找

- **接口**: `GET /search/device`
- **功能**: 根据ID查询指定设备信息
- **请求格式**: URL查询参数
- **请求参数**:
  - id: 设备ID，必填，整数类型
- **请求示例**: `http://localhost:8080/search/device?id=1001`
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "设备查询成功",
    "data": {
      "ID": 1,
      "DeviceName": "设备1",
      "DeviceType": 1,
      "DeviceID": 1001,
      "SuperiorDeviceID": 0,
      "DeviceStatus": 1,
      "CertID": "cert_id_1",
      "KeyID": "key_id_1",
      "RegisterIP": "192.168.1.100",
      "Email": "device1@example.com",
      "CreatedAt": "2024-03-05T15:00:00Z"
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "设备不存在"
  }
  ```

#### 4. 更新设备信息

- **接口**: `PUT /update/devices/:id`
- **功能**: 更新指定设备的信息
- **路径参数**: id - 设备ID
- **请求格式**: JSON
- **请求参数**: 与注册接口相同，字段可选
- **请求示例**:
  ```json
  {
    "deviceName": "新设备名",
    "passWD": "新密码",
    "deviceStatus": 2,
    "email": "newemail@example.com"
  }
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "message": "设备信息更新成功"
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "设备不存在"
  }
  ```

### 证书管理接口

#### 1. 绑定用户证书

- **接口**: `POST /bind/users/:id/cert`
- **功能**: 上传并绑定用户的证书文件
- **路径参数**: id - 用户ID
- **请求格式**: multipart/form-data
- **请求参数**:

  - cert: 证书文件（.pem格式）
- **请求示例 (curl)**:

  ```bash
  curl -X POST http://localhost:8080/bind/users/1001/cert \
    -F "cert=@/path/to/user_certificate.pem"
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:

  ```json
  {
    "code": 200,
    "message": "证书绑定成功",
    "data": {
      "userID": "1001",
      "certPath": "/d/code/golang/git/gin-server/regist/certs/certs/user_1001.pem"
    }
  }
  ```
- **响应示例 (失败)**:

  ```json
  {
    "error": "用户不存在"
  }
  ```

#### 2. 绑定用户密钥

- **接口**: `POST /bind/users/:id/key`
- **功能**: 上传并绑定用户的密钥文件
- **路径参数**: id - 用户ID
- **请求格式**: multipart/form-data
- **请求参数**:
  - key: 密钥文件（.pem格式）
- **请求示例 (curl)**:
  ```bash
  curl -X POST http://localhost:8080/bind/users/1001/key \
    -F "key=@/path/to/user_private_key.pem"
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "密钥绑定成功",
    "data": {
      "userID": "1001",
      "keyPath": "/d/code/golang/git/gin-server/regist/certs/keys/user_1001.pem"
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "无法保存密钥文件"
  }
  ```

#### 3. 绑定设备证书

- **接口**: `POST /bind/devices/:id/cert`
- **功能**: 上传并绑定设备的证书文件
- **路径参数**: id - 设备ID
- **请求格式**: multipart/form-data
- **请求参数**:
  - cert: 证书文件（.pem格式）
- **请求示例 (curl)**:
  ```bash
  curl -X POST http://localhost:8080/bind/devices/1001/cert \
    -F "cert=@/path/to/device_certificate.pem"
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "证书绑定成功",
    "data": {
      "deviceID": "1001",
      "certPath": "/d/code/golang/git/gin-server/regist/certs/certs/device_1001.pem"
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "设备不存在"
  }
  ```

#### 4. 绑定设备密钥

- **接口**: `POST /bind/devices/:id/key`
- **功能**: 上传并绑定设备的密钥文件
- **路径参数**: id - 设备ID
- **请求格式**: multipart/form-data
- **请求参数**:
  - key: 密钥文件（.pem格式）
- **请求示例 (curl)**:
  ```bash
  curl -X POST http://localhost:8080/bind/devices/1001/key \
    -F "key=@/path/to/device_private_key.pem"
  ```
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "密钥绑定成功",
    "data": {
      "deviceID": "1001",
      "keyPath": "/d/code/golang/git/gin-server/regist/certs/keys/device_1001.pem"
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "文件大小超过限制"
  }
  ```

#### 5. 获取证书信息

- **接口**: `GET /cert/info`
- **功能**: 获取指定实体（用户或设备）的证书信息
- **请求格式**: URL查询参数
- **请求参数**:
  - type: 实体类型（user或device）
  - id: 实体ID
- **请求示例**: `http://localhost:8080/cert/info?type=user&id=1001`
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "code": 200,
    "message": "获取证书信息成功",
    "data": {
      "id": 1,
      "entity_type": "user",
      "entity_id": "1001",
      "cert_path": "/d/code/golang/git/gin-server/regist/certs/certs/user_1001.pem",
      "key_path": "/d/code/golang/git/gin-server/regist/certs/keys/user_1001.pem",
      "upload_time": "2023-08-15T14:30:15Z"
    }
  }
  ```
- **响应示例 (未找到记录)**:
  ```json
  {
    "code": 200,
    "message": "未找到证书记录",
    "data": null
  }
  ```
- **响应示例 (参数错误)**:
  ```json
  {
    "error": "缺少必要的参数"
  }
  ```

### 认证管理接口

#### 1. 获取认证记录

- **接口**: `GET /auth/records`
- **功能**: 查询认证记录
- **请求格式**: URL查询参数
- **请求参数**:
  - username: 用户名（可选）
  - reply: 认证结果（可选）
  - start_date: 开始日期（可选）
  - end_date: 结束日期（可选）
  - page: 页码，默认1
  - page_size: 每页记录数，默认10
  - class: 认证类别（可选）
- **请求示例**: `http://localhost:8080/auth/records?username=user1&reply=Access-Accept&page=1&page_size=20`
- **响应格式**: JSON
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "Success",
    "data": {
      "total": 35,
      "total_pages": 2,
      "page": 1,
      "page_size": 20,
      "records": [
        {
          "id": 1,
          "username": "user1",
          "reply": "Access-Accept",
          "authdate": "2024-03-07T10:00:00Z",
          "class": "VPN"
        },
        {
          "id": 2,
          "username": "user1",
          "reply": "Access-Accept",
          "authdate": "2024-03-07T11:30:00Z",
          "class": "VPN"
        }
        // 更多记录...
      ]
    }
  }
  ```

### 日志管理接口

#### 1. 获取最新日志

- **接口**: `GET /logs/latest`
- **功能**: 获取系统中最新生成的日志文件内容
- **请求格式**: 无参数
- **响应格式**: JSON
- **响应示例 (成功)**:
  ```json
  {
    "timeRange": {
      "startTime": "2024-03-07T10:00:00Z",
      "duration": 300
    },
    "securityEvents": {
      "events": [
        {
          "eventId": 1001,
          "deviceId": "1001",
          "eventTime": "2024-03-07T10:02:00Z",
          "eventType": 1,
          "eventCode": "SEC_001",
          "eventDesc": "异常登录尝试",
          "createdAt": "2024-03-07T10:02:01Z"
        }
      ]
    },
    "performanceEvents": {
      "securityDevices": [
        {
          "deviceId": "1001",
          "cpuUsage": 45,
          "memoryUsage": 60,
          "onlineDuration": 3600,
          "status": 1,
          "gatewayDevices": [
            {
              "deviceId": "1002",
              "cpuUsage": 30,
              "memoryUsage": 40,
              "onlineDuration": 3600,
              "status": 1,
              "users": [
                {
                  "userId": 10001,
                  "status": 1,
                  "onlineDuration": 1800,
                  "behaviors": [
                    {
                      "time": "2024-03-07T10:01:00Z",
                      "type": 1,
                      "dataType": 1,
                      "dataSize": 1024
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "faultEvents": {
      "events": [
        {
          "eventId": 2001,
          "deviceId": "1002",
          "eventTime": "2024-03-07T10:03:00Z",
          "eventType": 2,
          "eventCode": "FAULT_001",
          "eventDesc": "设备离线",
          "createdAt": "2024-03-07T10:03:01Z"
        }
      ]
    }
  }
  ```
- **响应示例 (失败)**:
  ```json
  {
    "error": "查找最新日志文件失败: 日志目录为空，没有日志文件"
  }
  ```
